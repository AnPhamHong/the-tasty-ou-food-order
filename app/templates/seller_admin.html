<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Seller Admin Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            min-height: 100vh;
            background: #f0f2f5;
            margin: 0;
        }

        /* Sidebar */
        .sidebar {
            width: 250px;
            min-height: 100vh;
            background: linear-gradient(to bottom, #1e3c72, #2a5298);
            color: #fff;
            position: fixed;
            top: 0;
            left: 0;
            padding-top: 60px;
            transition: width 0.3s;
        }

        .sidebar a {
            display: flex;
            align-items: center;
            color: #fff;
            text-decoration: none;
            padding: 14px 20px;
            margin: 5px 10px;
            border-radius: 8px;
            font-weight: 500;
            transition: background 0.2s;
        }

        .sidebar a i {
            margin-right: 12px;
            font-size: 18px;
        }

        .sidebar a:hover,
        .sidebar a.active {
            background-color: rgba(255, 255, 255, 0.2);
        }

        /* Navbar */
        .navbar {
            position: fixed;
            top: 0;
            left: 250px;
            right: 0;
            height: 60px;
            background: linear-gradient(to right, #1e3c72, #2a5298);
            z-index: 1000;
            display: flex;
            align-items: center;
            padding: 0 20px;
        }

        .navbar .navbar-brand {
            color: #fff;
            font-weight: 600;
        }

        /* Content */
        .content-area {
            margin-left: 250px;
            padding: 80px 30px 30px 30px;
        }

        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 40px;
        }

        .dashboard-header h2 {
            color: #1e3c72;
            font-weight: 600;
        }

        /* Cards */
        .dashboard-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 25px;
        }

        .card {
            border-radius: 12px;
            padding: 30px 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            cursor: pointer;
            text-align: center;
            background: #fff;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        }

        .card i {
            font-size: 36px;
            margin-bottom: 15px;
            background: linear-gradient(to right, #1e3c72, #2a5298);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .card h5 {
            font-weight: 600;
            margin-bottom: 10px;
        }

        .card p {
            font-size: 0.9rem;
            color: #555;
        }

        .card .btn {
            margin-top: 12px;
            background: linear-gradient(to right, #1e3c72, #2a5298);
            border: none;
            color: #fff;
            font-size: 0.9rem;
        }

        .card .btn:hover {
            opacity: 0.9;
        }

        .module {
            display: none;
        }

        #overlay {
            display: none;
        }

        #overlay.active {
            display: flex;
        }

        /* Hide all modules by default */
        @media (max-width: 768px) {
            .sidebar {
                width: 200px;
            }

            .navbar {
                left: 200px;
            }

            .content-area {
                margin-left: 200px;
                padding: 100px 20px 20px 20px;
            }
        }
    </style>
</head>

<body>

    <!-- Sidebar -->
    <div class="sidebar">
        <h4 class="text-center mb-4"><i class="fa-solid fa-utensils me-2"></i>Seller Admin</h4>
        <a href="#" class="active" id="menu-link"><i class="fa-solid fa-bowl-food"></i> Manage Menu</a>
        <a href="#" id="orders-link"><i class="fa-solid fa-receipt"></i> Manage Orders</a>
        <a href="#" id="orders-promotions"><i class="fa-solid fa-percent"></i></i> Magage Promotion</a>
        <a href="#" id="reports-link"><i class="fa-solid fa-chart-line"></i> Reports & Analytics</a>
        <a href="#" id="settings-link"><i class="fa-solid fa-gear"></i> Account Settings</a>
        <hr style="border-color: rgba(255,255,255,0.3); margin: 20px 10px;">
        <a href="#" id="logoutBtn" class="dropdown-item"><i class="fa-solid fa-right-from-bracket"></i>Logout</a>
    </div>

    <!-- Navbar -->
    <nav class="navbar">
        <a class="navbar-brand" href="#">OU Food Seller Admin</a>
    </nav>

    <!-- Content -->
    <div class="content-area">
        <div class="dashboard-header">
            <h2 id="dashboard-title">Welcome, Seller Admin!</h2>
        </div>
        <div id="dashboard-main">
            <!-- Modules -->
            <div id="module-menu" class="module">
                <button class="btn btn-primary mb-3" id="addMenuBtn" data-bs-toggle="modal" data-bs-target="#menuModal">
                    Add New Dish
                </button>
                <div class="table-responsive">
                    <table class="table table-striped table-hover align-middle">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Image</th>
                                <th>Dish Name</th>
                                <th>Price</th>
                                <th>Category</th>
                                <th>Description</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="menuTableBody"></tbody>
                    </table>
                </div>
            </div>
            <div id="module-orders" class="module">
                <div class="table-responsive position-relative">
                    <div id="overlay"
                        style="z-index: 2;position: absolute;width: 100%;height: 100%;background:rgba(0,0,0,0.5);justify-content: center;align-items: center;">
                        <div class="spinner-border text-blue" role="status"></div>
                    </div>
                    <table class="table table-striped table-hover align-middle ">

                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Transaction ID</th>
                                <th>Customer</th>
                                <th>Phone</th>
                                <th>Status</th>
                                <th>Total</th>
                                <th>Change Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="ordersTableBody">
                            <!-- JS sẽ render tại đây -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div id="module-promotions" class="module">
                <div class="row g-3">
                    <!-- Existing Promotions -->
                    <div class="col-md-6">
                        <div class="card p-3 h-100">
                            <h5>Existing Promotions</h5>
                            <div id="promotionList" class="accordion">
                                <!-- JS inject promotions (accordion items) -->
                            </div>
                        </div>
                    </div>

                    <!-- Create Promotion -->
                    <div class="col-md-6">
                        <div class="card p-3 h-100">
                            <h5>Create Promotion</h5>
                            <input type="text" id="promoName" placeholder="Promotion name" class="form-control mb-2">
                            <input type="date" id="promoStart" class="form-control mb-2">
                            <input type="date" id="promoEnd" class="form-control mb-2">
                            <input type="number" id="promoDiscount" placeholder="Discount %" class="form-control mb-2">

                            <h5 class="cursor-default mt-2">Add Items to Promotion</h5>
                            <a href="#" class="btn btn-primary" style="width: fit-content; margin: 1rem auto;"
                                id="select-all-for-promotion">Select
                                All</a>
                            <div id="promoItems" class="list-group mb-2" style="border-top: none; border-bottom: none;">
                                <!-- JS sẽ inject các món ăn ở đây -->
                            </div>

                            <button class="btn btn-primary w-100" id="createPromoBtn">
                                <span class="d-none spinner-border spinner-border-sm me-2" role="status"></span>
                                <span class="btn-text">Create Promotion</span></button>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div id="module-reports" class="module page-wrapper">
                <div class="page-body">
                    <div class="container-fluid">
                        <div class="row g-3">
                            <div class="card shadow-sm p-3 mb-4">
                                <h5>Monthly Revenue & Order Summary</h5>
                                <p>This report shows the total revenue and number of completed orders for each month of
                                    the selected year, helping restaurants track performance trends and identify peak
                                    months.</p>

                                <canvas id="monthlyRevenueChart" height="150"></canvas>
                            </div>
                        </div>
                        <div class="row d-flex align-items-stretch">
                            <div class="col-lg-6 col-md-12 mb-4">
                                <div class="card shadow-sm p-3 h-100">
                                    <h5>Top Selling Dishes</h5>
                                    <p>This report lists the most popular dishes based on the total quantity sold within
                                        the selected time period, helping restaurants identify customer favorites and
                                        best-performing menu items.</p>
                                    <canvas id="topDishesChart" height="150"></canvas>
                                </div>
                            </div>
                            <div class="col-lg-6 col-md-12 mb-4">
                                <div class="card shadow-sm p-3 h-100">
                                    <h5>Top Selling Dishes</h5>
                                    <p>This report lists the most popular dishes based on the total quantity sold within
                                        the selected time period, helping restaurants identify customer favorites and
                                        best-performing menu items.</p>
                                    <div class="table-responsive">
                                        <table class="table table-striped table-hover align-middle">
                                            <thead>
                                                <tr>
                                                    <th>#</th>
                                                    <th>Dish</th>
                                                    <th>Quantity Sold</th>
                                                    <th>Share</th>
                                                </tr>
                                            </thead>
                                            <tbody id="topDishesTableBody">
                                                <!-- JS inject data -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row d-flex align-items-stretch">
                            <div class="col-lg-6 col-md-12 mb-4">
                                <div class="card shadow-sm p-3 h-100">
                                    <h5>Sales by Category</h5>
                                    <p>This report shows the total quantity sold and revenue generated for each product
                                        category within the selected time period, helping restaurants identify which
                                        types
                                        of dishes contribute most to sales and overall revenue.</p>
                                    <div class="row">
                                        <div class="col-lg-6 col-12 mb-3">
                                            <canvas id="categorySalesChart" height="250"></canvas>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-6 col-md-12 mb-4">
                                <div class="card shadow-sm p-3 h-100">
                                    <h5>Top 10 Highest Value Orders</h5>
                                    <p>This report lists the top 10 orders with the highest total amount, helping
                                        restaurants track large transactions and VIP customers.</p>
                                    <div class="table-responsive">
                                        <table class="table table-striped table-hover align-middle">
                                            <thead>
                                                <tr>
                                                    <th>#</th>
                                                    <th>Customer</th>
                                                    <th>Total ($)</th>
                                                    <th>Order Date</th>
                                                    <th>Share</th>
                                                </tr>
                                            </thead>
                                            <tbody id="topOrdersTableBody">
                                                <!-- JS inject -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>


            <div id="module-settings" class="module">
                <form id="accountForm">
                    <div class="mb-3">
                        <label for="name" class="form-label">Full Name</label>
                        <input type="text" required class="form-control" id="name-account" value="">
                    </div>
                    <div class="mb-3">
                        <label for="email" class="form-label">Email</label>
                        <input type="email" required class="form-control" id="email-account" value="">
                    </div>
                    <div class="mb-3">
                        <label for="email" class="form-label">Phone</label>
                        <input disabled="number" required class="form-control" id="phone-account" value="028326732">
                    </div>
                    <div class="mb-3">
                        <label for="password" class="form-label">Password</label>
                        <input type="password" class="form-control" id="password-account" value="" minlength="6"
                            placeholder="Enter new password">
                    </div>
                    <button type="submit" class="btn btn-primary">Update Info</button>
                </form>

            </div>

        </div>
    </div>


    <!-- Modal Add/Edit -->
    <div class="modal fade" id="menuModal" tabindex="-1" aria-labelledby="menuModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <form id="menuForm">
                    <div class="modal-header">

                        <h5 class="modal-title" id="menuModalLabel">Add New Dish</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>

                    </div>
                    <div class="modal-body">
                        <input type="hidden" id="menuId">
                        <div class="mb-3">
                            <label class="form-label">Dish Name</label>
                            <input type="text" class="form-control" id="menuName" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Image URL</label>
                            <input type="text" class="form-control" id="menuImage">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Price</label>
                            <input type="number" step="0.01" class="form-control" id="menuPrice" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Category</label>
                            <!-- <input type="text" class="form-control" id="menuCategory"> -->
                            <input list="categoryList" class="form-control" id="menuCategoryModal">
                            <datalist id="categoryListModal"></datalist>

                        </div>
                        <div class="mb-3">
                            <label class="form-label">Description</label>
                            <textarea class="form-control" id="menuDescription"></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="submit" class="btn btn-primary" id="saveDishBtn">
                            <span class="d-none spinner-border spinner-border-sm me-2" role="status"></span>
                            <span class="btn-text">Save Dish</span></button>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal xem chi tiết đơn hàng -->
    <div class="modal fade" id="orderDetailModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Order Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="orderDetailBody">
                    <!-- JS sẽ render chi tiết order -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // JS toggle overlay
        function showOverlay() {
            document.getElementById("overlay").classList.add("active");
        }

        function hideOverlay() {
            document.getElementById("overlay").classList.remove("active");
        }

    </script>

    <script>
        // Transaction chart
        new Chart(document.getElementById("transactionChart"), {
            type: "bar",
            data: {
                labels: ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug"],
                datasets: [{
                    label: "Sales",
                    data: [90, 80, 95, 70, 100, 85, 95, 80],
                    backgroundColor: "#2a5298"
                }]
            }
        });

        // Summary chart
        new Chart(document.getElementById("summaryChart"), {
            type: "line",
            data: {
                labels: ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"],
                datasets: [{
                    label: "Customers",
                    data: [20, 30, 40, 60, 50, 70, 80],
                    borderColor: "#2a5298",
                    fill: false
                }]
            }
        });

        // Revenue chart
        new Chart(document.getElementById("revenueChart"), {
            type: "bar",
            data: {
                labels: ["Food", "Beverage", "Snack"],
                datasets: [{
                    label: "Revenue",
                    data: [500, 300, 350],
                    backgroundColor: ["#1e3c72", "#2a5298", "#4b7bec"]
                }]
            }
        });

        // Activity chart
        new Chart(document.getElementById("activityChart"), {
            type: "doughnut",
            data: {
                labels: ["Sale", "Purchase", "Other"],
                datasets: [{
                    data: [52.41, 18.86, 28.73],
                    backgroundColor: ["#1e3c72", "#2a5298", "#4b7bec"]
                }]
            }
        });
    </script>
    <script>
        // === Module switch ===
        const modules = {
            "menu-link": document.getElementById("module-menu"),
            "orders-link": document.getElementById("module-orders"),
            "reports-link": document.getElementById("module-reports"),
            "settings-link": document.getElementById("module-settings"),
            "orders-promotions": document.getElementById("module-promotions"),
        };
        const sidebarLinks = document.querySelectorAll(".sidebar a");
        const dashboardTitle = document.getElementById("dashboard-title");

        function showModule(id) {
            Object.values(modules).forEach(m => m.style.display = "none");
            if (modules[id]) modules[id].style.display = "block";
        }

        // Attach click on sidebar
        sidebarLinks.forEach(link => {
            link.addEventListener("click", e => {
                e.preventDefault();
                sidebarLinks.forEach(l => l.classList.remove("active"));
                link.classList.add("active");
                dashboardTitle.textContent = link.textContent.trim();
                showModule(link.id);
            });
        });

        // Show default module
        showModule("menu-link");
        const menuTableBody = document.getElementById('menuTableBody');
        const menuModalEl = document.getElementById('menuModal');
        const menuModal = new bootstrap.Modal(menuModalEl);
        const menuForm = document.getElementById('menuForm');
        const addMenuBtn = document.getElementById('addMenuBtn');
        let currentEditId = null;
        let categories = [];

        // Load categories from server
        async function loadCategories() {
            const restaurantId = localStorage.getItem("restaurantId") ?? 1;
            const res = await fetch(`/api/categories?restaurant_id=${restaurantId}`);
            categories = await res.json();
            const datalist = document.getElementById('categoryListModal');
            datalist.innerHTML = '';
            categories.forEach(cat => datalist.innerHTML += `<option value="${cat}">`);
        }

        // Load menu items
        async function loadMenuItems() {
            const restaurantId = localStorage.getItem("restaurantId") ?? 1;
            const res = await fetch(`/api/menu?restaurant_id=${restaurantId}`);
            const items = await res.json();
            menuTableBody.innerHTML = '';
            items.forEach((item, index) => {
                menuTableBody.innerHTML += `
            <tr data-id="${item.id}">
                <td>${index + 1}</td>
                <td><img src="${item.image_url}" style="width:60px;height:60px;object-fit:cover"/></td>
                <td>${item.name}</td>
                <td>$${item.price}</td>
                <td>${item.category || ''}</td>
                <td>${item.description || ''}</td>
                <td>
                    <button class="btn btn-sm btn-warning edit-btn">Edit</button>
                    <button class="btn btn-sm btn-danger delete-btn">Delete</button>
                </td>
            </tr>
        `;
            });
            attachMenuButtons();
        }

        // Attach Edit/Delete buttons
        function attachMenuButtons() {
            document.querySelectorAll('.edit-btn').forEach(btn => {
                btn.addEventListener('click', e => {
                    const tr = e.target.closest('tr');
                    currentEditId = tr.dataset.id;
                    document.getElementById('menuModalLabel').textContent = 'Edit Dish';
                    document.getElementById('menuName').value = tr.children[2].textContent;
                    document.getElementById('menuImage').value = tr.children[1].querySelector('img')
                        .src;
                    document.getElementById('menuPrice').value = tr.children[3].textContent.replace('$',
                        '');
                    document.getElementById('menuCategoryModal').value = tr.children[4].textContent;
                    document.getElementById('menuDescription').value = tr.children[5].textContent;
                    loadCategories();
                    menuModal.show();
                });
            });

            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', async e => {
                    const tr = e.target.closest('tr');
                    if (confirm('Delete this dish?')) {
                        const restaurantId = localStorage.getItem("restaurantId");
                        await fetch(`/api/menu/${tr.dataset.id}`, {
                            method: 'DELETE',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                restaurant_id: restaurantId
                            })
                        });
                        loadMenuItems();
                    }
                });
            });

        }

        // Show modal for Add
        addMenuBtn.addEventListener('click', () => {
            menuForm.reset();
            loadCategories();
            document.getElementById('menuModalLabel').textContent = 'Add New Dish';
            currentEditId = null;
            menuModal.show();
        });

        // Handle Add/Edit form submit
        menuForm.addEventListener('submit', async e => {
            e.preventDefault();
            const saveBtn = document.getElementById("saveDishBtn");
            const spinner = saveBtn.querySelector(".spinner-border");
            const btnText = saveBtn.querySelector(".btn-text");

            const payload = {
                restaurant_id: localStorage.getItem("restaurantId"),
                name: document.getElementById('menuName').value,
                image_url: document.getElementById('menuImage').value,
                price: parseFloat(document.getElementById('menuPrice').value),
                category: document.getElementById('menuCategoryModal').value,
                description: document.getElementById('menuDescription').value
            };

            try {

                // active loading
                saveBtn.disabled = true;
                spinner.classList.remove("d-none");
                btnText.textContent = "Saving...";
                let url = '/api/menu';
                let method = 'POST';
                if (currentEditId) {
                    url += `/${currentEditId}`;
                    method = 'PUT';
                }

                const res = await fetch(url, {
                    method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                const data = await res.json();
                if (data.status === 'success') {
                    alert('Success');
                    menuForm.reset();
                    currentEditId = null;
                    menuModal.hide();
                    loadMenuItems();
                    loadCategories(); // reload categories to include new one
                } else {
                    alert(data.message || 'Error saving dish');
                }
            } catch (err) {
                console.error(err);
                alert('Server error');
            } finally {
                // deactivate loading
                saveBtn.disabled = false;
                spinner.classList.add("d-none");
                btnText.textContent = "Save Dish";
            }
        });

        // Reset modal on close
        menuModalEl.addEventListener('hidden.bs.modal', () => {
            menuForm.reset();
            document.getElementById('menuModalLabel').textContent = 'Add New Dish';
            currentEditId = null;
        });

        // Initial load
        loadCategories();
        loadMenuItems();
    </script>
    <!-- script for acount info module -->
    <script>
        const userId = localStorage.getItem("userid");
        const accountForm = document.getElementById('accountForm');

        if (accountForm) {

            async function loadUserInfo() {
                if (!userId) {
                    localStorage.clear();
                    window.location.href = "/login";
                    return alert("You are not logged in")
                }
                try {
                    const res = await fetch(`/api/user?user_id=${userId}`);
                    const data = await res.json();
                    if (data.status === 'success') {
                        const user = data.user;
                        accountForm.querySelector('#name-account').value = user.username || '';
                        accountForm.querySelector('#email-account').value = user.email || '';
                    } else {
                        alert(data.message);
                    }
                } catch (err) {
                    console.error(err);
                }
            }

            accountForm.addEventListener('submit', async e => {
                e.preventDefault();
                if (!userId) {
                    localStorage.clear();
                    window.location.href = "/login";
                    return alert("You are not logged in")
                }

                const payload = {
                    user_id: userId,
                    username: document.getElementById('name-account').value,
                    email: document.getElementById('email-account').value,
                    avatar_url: document.getElementById('avatar-account').value
                };
                const password = document.getElementById('password-account').value;
                if (password) payload.password = password;

                try {
                    const res = await fetch('/api/user', {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(payload)
                    });
                    const data = await res.json();
                    if (data.status === 'success') {
                        alert('Updated successfully');
                        loadUserInfo();

                        localStorage.clear();
                        window.location.href = "/login";
                    } else {
                        alert(data.message || 'Error updating info');
                    }
                } catch (err) {
                    console.error(err);
                    alert('Server error');
                }
            });

            loadUserInfo();
        }
    </script>
    <script>
        async function loadOrders(restaurantId) {
            try {
                const res = await fetch(`/orders/restaurant/${restaurantId}`);
                const orders = await res.json();

                const tbody = document.getElementById("ordersTableBody");
                tbody.innerHTML = "";

                orders.forEach((order, index) => {
                    let statusBadge = "";
                    switch (order.status) {
                        case "Pending":
                            statusBadge = `<span class="badge bg-primary">Pending</span>`;
                            break;
                        case "Preparing":
                            statusBadge = `<span class="badge bg-warning text-dark">Preparing</span>`;
                            break;
                        case "Rejected":
                            statusBadge = `<span class="badge bg-danger">Rejected</span>`;
                            break;
                        case "Delivering":
                            statusBadge = `<span class="badge bg-info text-dark">Delivering</span>`;
                            break;
                        case "Completed":
                            statusBadge = `<span class="badge bg-success">Completed</span>`;
                            break;
                        default:
                            statusBadge = `<span class="badge bg-secondary">${order.status}</span>`;
                    }

                    // Quy định disabled option theo luồng
                    const statusSelect = `
                        <select style="width: 100%;" class="form-select form-select-sm" name="change-status"
                                onchange="updateOrderStatus(${order.id}, this.value)">
                        <option value="Pending" ${order.status === 'Pending' ? 'selected' : ''} 
                                ${order.status !== 'Pending' ? 'disabled' : ''}>
                            Pending
                        </option>
                        <option value="Preparing" ${order.status === 'Preparing' ? 'selected' : ''} 
                                ${!(order.status === 'Pending' || order.status === 'Preparing') ? 'disabled' : ''}>
                            Preparing
                        </option>
                        <option value="Rejected" ${order.status === 'Rejected' ? 'selected' : ''} 
                                ${!(order.status === 'Pending' || order.status === 'Rejected') ? 'disabled' : ''}>
                            Rejected
                        </option>
                        <option value="Delivering" ${order.status === 'Delivering' ? 'selected' : ''} 
                                ${!(order.status === 'Preparing' || order.status === 'Delivering') ? 'disabled' : ''}>
                            Delivering
                        </option>
                        <option value="Completed" ${order.status === 'Completed' ? 'selected' : ''} 
                                ${order.status !== 'Delivering' && order.status !== 'Completed' ? 'disabled' : ''}>
                            Completed
                        </option>
                        </select>
                    `;

                    tbody.innerHTML += `
                        <tr>
                            <td>${index + 1}</td>
                            <td>#${order.transaction_id}</td>
                            <td>${order.recipient_name}</td>
                            <td>${order.phone_number}</td>
                            <td>${statusBadge}</td>
                            <td>$${parseFloat(order.total).toFixed(2)}</td>
                            <td>
                                ${order.status === "Cancelled" ? "" : statusSelect}
                            </td>
                            <td>
                                <button class="btn btn-sm btn-primary" onclick="viewOrderDetail('${order.transaction_id}')">View Details</button>
                            </td>
                        </tr>
                    `;
                });
            } catch (err) {
                console.error("Error loading orders:", err);
            }
        }


        // Xem chi tiết đơn hàng
        async function viewOrderDetail(orderId) {
            try {
                const res = await fetch(`/orders/transaction/${orderId}`); // API chi tiết order
                const order = await res.json();

                const body = document.getElementById("orderDetailBody");

                let itemsHtml = order.items.map(item => `
                    <tr>
                        <td>
                        <div style="display: flex; align-items: center;">
                            <img src="${item.image_url}" style="width: 50px; height: 50px; object-fit: cover; border-radius: 0.5rem; margin-right: 0.75rem;">
                            <span>${item.food_name}</span>
                        </div>
                        </td>
                        <td class="text-center">${item.quantity}</td>
                        <td class="text-center">$${parseFloat(item.price).toFixed(2)}</td>
                        <td>${item.note || '-'}</td>
                    </tr>
                `).join("");

                body.innerHTML = `
                    <div class="mb-3">
                        <h6 style="margin-bottom: 16px;">Transaction ID: #${order.transaction_id}</h6>
                        <p>Customer: ${order.recipient_name}</p>
                        <p>Phone: ${order.phone_number}</p>
                        <p>Email: ${order.email}</p>
                        <p>Address: ${order.address}</p>
                        <p>Status: <span class="badge bg-${getStatusBadgeClass(order.status)}">${order.status}</span></p>
                        <p>Total: $${parseFloat(order.total).toFixed(2)}</p>
                    </div>

                    <table class="table table-sm table-bordered mt-3 align-middle">
                        <thead class="table-light">
                        <tr>
                            <th style="padding: .8rem .5rem;">Food</th>
                            <th style="padding: .8rem .5rem;" class="text-center">Qty</th>
                            <th style="padding: .8rem .5rem;" class="text-center">Price</th>
                            <th style="padding: .8rem .5rem;">Note</th>
                        </tr>
                        </thead>
                        <tbody>
                        ${itemsHtml}
                        </tbody>
                    </table>
                    ${order.status === "Pending" ? `
                    <div class="mt-3">
                        <label for="rejectReason" class="form-label">Reject Order</label>
                        <textarea id="rejectReason" class="form-control" placeholder="Enter reason for rejection"></textarea>
                        <button type="button" class="btn btn-danger mt-2" id="rejectOrderBtn">Reject Order</button>
                    </div>` : ""}
                `;

                function getStatusBadgeClass(status) {
                    switch (status) {
                        case "Pending":
                            return "primary";
                        case "Preparing":
                            return "warning text-dark";
                        case "Rejected":
                            return "danger";
                        case "Delivering":
                            return "info text-dark";
                        case "Completed":
                            return "success";
                        default:
                            return "secondary";
                    }
                }

                if (order.status === "Pending") {
                    const rejectBtn = document.getElementById("rejectOrderBtn");
                    const rejectReasonInput = document.getElementById("rejectReason");

                    rejectBtn.addEventListener("click", async () => {
                        const reason = rejectReasonInput.value.trim();
                        if (!reason) {
                            alert("Please enter a reason for rejection");
                            return;
                        }

                        try {
                            const res = await fetch(`/orders/${order.id}/status`, {
                                method: "PUT",
                                headers: {
                                    "Content-Type": "application/json"
                                },
                                body: JSON.stringify({
                                    status: "Rejected",
                                    reason
                                })
                            });
                            const data = await res.json();

                            if (res.ok) {
                                alert("Order rejected successfully");
                                // Ẩn modal sau khi reject
                                bootstrap.Modal.getInstance(document.getElementById("orderDetailModal"))
                                    .hide();
                                // Optionally reload orders list
                                loadOrders(order.restaurant_id);
                            } else {
                                alert("Error: " + data.error);
                            }
                        } catch (err) {
                            console.error(err);
                            alert("Server error while rejecting order");
                        }
                    });
                }

                // Show modal
                const modalEl = document.getElementById("orderDetailModal");
                const modal = bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl, {
                    backdrop: 'static',
                    keyboard: false
                });
                modal.show();
            } catch (err) {
                console.error("Error fetching order details:", err);
                alert("Failed to load order details.");
            }
        }

        async function updateOrderStatus(orderId, status) {
            showOverlay();
            try {
                const res = await fetch(`/orders/${orderId}/status`, {
                    method: "PUT",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        status
                    })
                });

                const data = await res.json();
                if (res.ok) {
                    alert(`Order #${orderId} updated to ${status}`);
                    const restaurantId = localStorage.getItem("restaurantId") ?? 1;
                    loadOrders(restaurantId); // reload list
                } else {
                    alert("Error: " + data.error);
                }
            } catch (err) {
                console.error("Error updating order:", err);
            } finally {
                hideOverlay()
            }
        }

        // load khi mở trang
        document.addEventListener("DOMContentLoaded", () => {
            const restaurantId = localStorage.getItem("restaurantId") ?? 1;
            loadOrders(restaurantId); // restaurant_id = 1
        });
    </script>
    <script>
        const restaurantId = localStorage.getItem("restaurantId") ?? 1;

        // DOM elements
        const promoName = document.getElementById("promoName");
        const promoStart = document.getElementById("promoStart");
        const promoEnd = document.getElementById("promoEnd");
        const promoDiscount = document.getElementById("promoDiscount");
        const promoItemsContainer = document.getElementById("promoItems");
        const promotionList = document.getElementById("promotionList");
        const createBtn = document.getElementById("createPromoBtn");

        // Cache
        let menuItemsCache = [];
        let promotionsCache = [];

        // ------------------- Fetch functions -------------------
        async function fetchMenuItems() {
            try {
                const res = await fetch(`/api/menu?restaurant_id=${restaurantId}`);
                if (!res.ok) throw new Error("Failed to fetch menu items");
                return await res.json();
            } catch (err) {
                console.error(err);
                return [];
            }
        }

        async function fetchPromotions() {
            try {
                const res = await fetch(`/promotions/restaurant/${restaurantId}`);
                if (!res.ok) throw new Error("Failed to fetch promotions");
                return await res.json();
            } catch (err) {
                console.error(err);
                return [];
            }
        }

        // ------------------- Render functions -------------------
        function renderMenuItemsForPromotions(items) {
            promoItemsContainer.innerHTML = items.map(item => `
        <label class="list-group-item d-flex justify-content-between align-items-center">
            <div>
                <input type="checkbox" class="form-check-input me-2 promo-item-checkbox" value="${item.id}">
                ${item.name}
            </div>
            <span>$${parseFloat(item.price).toFixed(2)}</span>
        </label>
    `).join("");
        }
        function renderPromotions(promos) {
            promotionList.innerHTML = `
    <div class="accordion" id="promotionAccordion">
      ${promos.map((p, idx) => `
        <div class="accordion-item mb-2" data-id="${p.id}">
          <h2 class="accordion-header" id="heading-${idx}">
            <button class="accordion-button collapsed d-flex justify-content-between align-items-center" 
                    type="button" data-bs-toggle="collapse" 
                    data-bs-target="#collapse-${idx}" 
                    aria-expanded="false" aria-controls="collapse-${idx}">
              <div class="me-2">
                <strong>${p.name} (${p.discount_pct}%)</strong><br>
                <small>${p.start_date} → ${p.end_date}</small>
              </div>
              <span class="badge bg-primary rounded-pill ms-auto">${p.items.length} items</span>
            </button>
          </h2>
          <div id="collapse-${idx}" class="accordion-collapse collapse" aria-labelledby="heading-${idx}" data-bs-parent="#promotionAccordion">
            <div class="accordion-body p-2">
              <ul class="list-group list-group-flush">
                ${p.items.map(item => `
                  <li class="list-group-item py-2 px-2">
                    <div class="d-flex justify-content-between align-items-center">
                      <div class="d-flex align-items-center">
                        <img src="${item.image_url}" alt="img" style="width: 60px; height: 60px; object-fit: cover; border-radius: .5rem; margin-right: 1rem;" />
                        ${item.name}
                      </div>
                      <span>$${parseFloat(item.price).toFixed(2)}</span>
                    </div>
                  </li>
                `).join("")}
              </ul>
            </div>
          </div>
        </div>
      `).join("")}
    </div>
  `;
        }


        //     function renderPromotions(promos) {
        //         promotionList.innerHTML = promos.map(p => `
        //     <li class="list-group-item mb-2" data-id="${p.id}">
        //         <div class="d-flex justify-content-between align-items-start">
        //             <div>
        //                 <strong>${p.name} (${p.discount_pct}%)</strong>
        //                 <br>
        //                 <small>${p.start_date} → ${p.end_date}</small>
        //             </div>
        //             <span class="badge bg-primary rounded-pill">${p.items.length} items</span>
        //         </div>
        //         <ul class="mt-2 list-group list-group-flush">
        //             ${p.items.map(item => `<li class="list-group-item py-1 px-2">
        //                 <div class="d-flex justify-content-between gap-2 align-items-center">
        //                     <div><img src="${item.image_url} alt="img" style="width: 60px; height: 60px; object-fit: cover; border-radius: .5rem; margin-right: 1rem;" />${item.name}</div>
        //                     <span>$${parseFloat(item.price).toFixed(2)}</span>
        //                 </div>
        //                 </li>`).join("")}
        //         </ul>
        //     </li>
        // `).join("");
        //     }

        // ------------------- Helper -------------------
        function getSelectedItemIds() {
            return Array.from(document.querySelectorAll('input.promo-item-checkbox:checked'))
                .map(cb => cb.value);
        }

        // ------------------- Init module -------------------
        async function initPromotionsModule() {
            // Load menu items only once
            menuItemsCache = await fetchMenuItems();
            renderMenuItemsForPromotions(menuItemsCache);

            // Load promotions only once
            promotionsCache = await fetchPromotions();
            renderPromotions(promotionsCache);
        }

        // ------------------- Create promotion -------------------
        createBtn.addEventListener("click", async () => {
            const createBtn = document.getElementById("createPromoBtn");
            const spinner = createBtn.querySelector(".spinner-border");
            const btnText = createBtn.querySelector(".btn-text");

            const name = promoName.value.trim();
            const start = promoStart.value;
            const end = promoEnd.value;
            const discount = parseFloat(promoDiscount.value);
            const selectedItems = getSelectedItemIds();

            if (!name || !start || !end || isNaN(discount) || selectedItems.length === 0) {
                return alert("Please fill all fields and select at least one item.");
            }

            try {

                createBtn.disabled = true;
                spinner.classList.remove("d-none");
                btnText.textContent = "Creating...";
                const res = await fetch("/promotions", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        restaurant_id: restaurantId,
                        name,
                        start_date: start,
                        end_date: end,
                        discount_pct: discount,
                        product_ids: selectedItems
                    })
                });

                if (!res.ok) {
                    const err = await res.json();
                    return alert(err.error || "Error creating promotion");
                }

                promotionsCache = await fetchPromotions();
                renderPromotions(promotionsCache);

                // Reset form
                promoName.value = "";
                promoStart.value = "";
                promoEnd.value = "";
                promoDiscount.value = "";
                document.querySelectorAll('input.promo-item-checkbox').forEach(cb => cb.checked = false);

                alert("Promotion created successfully!");
            } catch (err) {
                console.error(err);
                alert("Server error while creating promotion");
            } finally {
                // tắt loading
                createBtn.disabled = false;
                spinner.classList.add("d-none");
                btnText.textContent = "Create Promotion";
            }
        });

        // Handle select all item for promotions
        // Gắn sự kiện cho nút "Select All"
        document.getElementById("select-all-for-promotion").addEventListener("click", function (e) {
            e.preventDefault();

            const checkboxes = document.querySelectorAll(".promo-item-checkbox");
            const allChecked = Array.from(checkboxes).every(cb => cb.checked);

            // Nếu tất cả đã được chọn => bỏ chọn hết
            // Nếu chưa => chọn tất cả
            checkboxes.forEach(cb => cb.checked = !allChecked);

            // Đổi text nút cho dễ hiểu
            this.textContent = allChecked ? "Select All" : "Unselect All";
        });

        // ------------------- Init -------------------
        document.addEventListener("DOMContentLoaded", () => {
            initPromotionsModule();
        });
    </script>
    <script>
        async function loadMonthlyRevenueChart(restaurantId, year) {
            const res = await fetch(`/api/reports/monthly-revenue?restaurant_id=${restaurantId}&year=${year}`);
            const data = await res.json();

            const ctx = document.getElementById("monthlyRevenueChart").getContext("2d");

            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"],
                    datasets: [
                        {
                            label: `Revenue ($)`,
                            data: data.monthly_revenue,
                            yAxisID: 'yRevenue',
                            borderColor: "#F37335",
                            backgroundColor: "rgba(243,115,53,0.2)",
                            fill: true,
                            tension: 0.3
                        },
                        {
                            label: `Orders`,
                            data: data.monthly_orders,
                            yAxisID: 'yOrders',
                            borderColor: "#36A2EB",
                            backgroundColor: "rgba(54,162,235,0.2)",
                            fill: false,
                            tension: 0.3
                        }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { position: 'top' } },
                    scales: {
                        yRevenue: {
                            type: 'linear',
                            position: 'left',
                            beginAtZero: true,
                            title: { display: true, text: 'Revenue ($)' }
                        },
                        yOrders: {
                            type: 'linear',
                            position: 'right',
                            beginAtZero: true,
                            title: { display: true, text: 'Orders' },
                            grid: { drawOnChartArea: false } // không vẽ grid trùng
                        }
                    }
                }
            });
        }

        async function loadTopDishesChart(restaurantId, year, month = null, topN = 10) {
            let url = `/api/reports/top-dishes?restaurant_id=${restaurantId}&year=${year}&top_n=${topN}`;
            if (month) url += `&month=${month}`;

            const res = await fetch(url);
            const data = await res.json();

            const labels = data.top_dishes.map(d => d.food_name);
            const values = data.top_dishes.map(d => d.total_sold);

            const ctx = document.getElementById("topDishesChart").getContext("2d");
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: "Quantity Sold",
                        data: values,
                        backgroundColor: "#F37335"
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true } }
                }
            });
        }
        async function loadTopDishesTable(restaurantId, year, topN = 10) {
            const res = await fetch(`/api/reports/top-dishes?restaurant_id=${restaurantId}&year=${year}&top_n=${topN}`);
            const data = await res.json();

            const tbody = document.getElementById("topDishesTableBody");

            // Tìm max quantity để scale mini bar
            const maxQty = Math.max(...data.top_dishes.map(d => d.total_sold));

            tbody.innerHTML = data.top_dishes.map((dish, index) => {
                const sharePercent = (dish.total_sold / maxQty) * 100;
                return `
            <tr>
                <td>${index + 1}</td>
                <td>${dish.food_name}</td>
                <td>${dish.total_sold}</td>
                <td>
                    <div class="progress" style="height: 12px;" title="${sharePercent.toFixed(1)}%">
                        <div class="progress-bar bg-gradient" role="progressbar"
                             style="width: ${sharePercent}%;"
                             aria-valuenow="${dish.total_sold}" aria-valuemin="0" aria-valuemax="${maxQty}">
                        </div>
                    </div>
                </td>
            </tr>
        `;
            }).join("");

            // Khởi tạo tooltip Bootstrap
            const tooltipTriggerList = [].slice.call(document.querySelectorAll('[title]'))
            tooltipTriggerList.map(function (el) {
                return new bootstrap.Tooltip(el)
            });
        }

        async function loadCategorySales(restaurantId, year) {
            const res = await fetch(`/api/reports/category-sales?restaurant_id=${restaurantId}&year=${year}`);
            const data = await res.json();

            const categories = data.category_sales;
            if (categories.length === 0) return;

            // Horizontal Bar Chart
            const chartLabels = categories.map(c => c.category);
            const chartData = categories.map(c => c.revenue);

            const ctx = document.getElementById("categorySalesChart").getContext("2d");
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: chartLabels,
                    datasets: [{
                        label: "Revenue",
                        data: chartData,
                        backgroundColor: "#F37335"
                    }]
                },
                options: {
                    indexAxis: 'y',  // horizontal
                    responsive: true,
                    plugins: { legend: { display: false } },
                    scales: { x: { beginAtZero: true } }
                }
            });
        }
        async function loadTopOrdersTable(restaurantId, year, topN = 10) {
            const res = await fetch(`/api/reports/top-orders?restaurant_id=${restaurantId}&year=${year}&top_n=${topN}`);
            const data = await res.json();

            const tbody = document.getElementById("topOrdersTableBody");
            const maxTotal = Math.max(...data.top_orders.map(o => o.order_total));

            tbody.innerHTML = data.top_orders.map((order, index) => {
                const sharePercent = (order.order_total / maxTotal) * 100;
                return `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${order.recipient_name}</td>
                        <td>$${parseFloat(order.order_total).toFixed(2)}</td>
                        <td>${new Date(order.order_time).toLocaleDateString()}</td>
                        <td>
                            <div class="progress" style="height: 12px;" title="${sharePercent.toFixed(1)}%">
                                <div class="progress-bar bg-gradient" role="progressbar"
                                    style="width: ${sharePercent}%;"
                                    aria-valuenow="${order.order_total}" aria-valuemin="0" aria-valuemax="${maxTotal}">
                                </div>
                            </div>
                        </td>
                    </tr>
                `;
            }).join("");

            // Bootstrap tooltip
            const tooltipTriggerList = [].slice.call(document.querySelectorAll('[title]'));
            tooltipTriggerList.map(el => new bootstrap.Tooltip(el));
        }

        // Khi load page
        document.addEventListener("DOMContentLoaded", () => {
            const restaurantId = localStorage.getItem("restaurantId");
            const year = new Date().getFullYear();
            loadMonthlyRevenueChart(restaurantId, year);
            loadTopDishesChart(restaurantId, year);
            loadTopDishesTable(restaurantId, year);
            loadCategorySales(restaurantId, year);
            loadTopOrdersTable(restaurantId, year);
        });

    </script>

    <script src="/static/js/logout.js"></script>
</body>

</html>